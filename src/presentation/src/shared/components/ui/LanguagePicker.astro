---
import Icon from "~/presentation/shared/components/ui/icons/Icon.astro";
import Container, { Tokens } from "~/presentation/Container";
import type II18n from "~/core/acore-ts/i18n/abstraction/II18n";
import { useI18nStatic } from "../../hooks/useI18n";
import { TranslationKeys } from "~/domain/models/TranslationKey";
import { navigate } from "astro:transitions/client";
import Dropdown from "~/core/acore-astro/components/Dropdown.astro";

const i18n = Container.resolve<II18n>(Tokens.I18n);
const translate = useI18nStatic(Astro.url);
const locales = i18n.locales;
const currentLocale = i18n.getLocaleFromUrl(Astro.url, i18n.locales[0]);

function getLocaleUrl(locale: string) {
  return i18n.getLocaleUrl(Astro.url, locale, i18n.locales[0]).pathname;
}
---

<Dropdown value={currentLocale} name="language" dropdownClass="min-w-[120px] dark:bg-neutral-800 dark:text-neutral-200">
  <button
    slot="trigger"
    type="button"
    aria-label="Change language"
    class="ac-locales-dropdown-button inline-flex items-center gap-x-2 rounded-full px-1.5 py-1.5 text-sm font-medium text-neutral-600 outline-none ring-zinc-500 transition duration-300 hover:bg-neutral-200 hover:text-orange-400 dark:border-neutral-700 dark:text-neutral-400 dark:ring-zinc-200 dark:hover:bg-neutral-700 dark:hover:text-orange-300 dark:focus:outline-none"
  >
    <Icon name="earth" class="animate-ac-glow text-emerald-500" />
  </button>

  <div slot="content">
    {
      locales.map((locale) => (
        <button
          data-locale-url={getLocaleUrl(locale)}
          data-locale={locale}
          onclick={`
            const locale = this.getAttribute('data-locale');
            const localeUrl = this.getAttribute('data-locale-url');
            localStorage.setItem('preffered_locale', locale);
            window.acNavigate(localeUrl);
          `}
          class="ac-locale-button w-full px-4 py-2 text-left hover:bg-gray-100 dark:hover:bg-neutral-700"
        >
          {translate(TranslationKeys[`common_${locale}` as keyof typeof TranslationKeys])}
        </button>
      ))
    }
  </div>
</Dropdown>

<script>
  import { navigate } from "astro:transitions/client";
  import type II18n from "~/core/acore-ts/i18n/abstraction/II18n";
  import Container, { Tokens } from "~/presentation/Container";

  // Add navigate to window object
  (window as any).acNavigate = navigate;

  redirectPrefferedLocale();

  function redirectPrefferedLocale() {
    const currentUrl = new URL(window.location.href);

    const i18n = Container.resolve<II18n>(Tokens.I18n);
    const locales = i18n.locales;
    const currentLocale = i18n.getLocaleFromUrl(currentUrl, i18n.locales[0]);
    const prefferedLocale = localStorage.getItem("preffered_locale") || i18n.getBrowserLocale().split("-")[0];

    if (prefferedLocale && locales.includes(prefferedLocale) && currentLocale !== prefferedLocale) {
      const localizedUrl = i18n.getLocaleUrl(currentUrl, prefferedLocale, i18n.locales[0]);
      navigate(localizedUrl.pathname);
    }
  }
</script>
